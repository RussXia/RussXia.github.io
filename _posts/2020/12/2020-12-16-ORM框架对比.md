---
layout: blog
title: "ORM框架对比"
catalog: true
tag: [Java,ORM,Mybatis,JPA,2020,K8S]
---

# ORM框架对比

<a name="wyCX9"></a>
# 前言
    本文主要对比的是一下几个 `ORM` 框架,这几个框架，他们都不属于JPA框架，但是在实际中却使用广泛。和JPA这类的ORM框架相比，这些框架更侧重于SQL的原生能力，更为轻量，开发更为简单。

- Mybatis
- Mybatis Plus
- Mybatis Dynamic SQL
- jOOQ

    JPA是由 **JCP** 组织发布的 `Java EE` 标准之一(并非具体实现)，全称 `Java Persistance API` 。作为规范，JPA更关注的是模型之间关系，致力于屏蔽原生SQL。JPA最开始的对象关系映射模型基于Hibernate，JPA的第一版很多设计和规范，都是吸收了Hibernate的设计。<br />    除Hibernate外，TopLink、OpenJPA都很好地实现了JPA接口。其中，Hibernate依然是现在最成熟的 `JPA`框架，获得Sun的兼容认证。<br />    可以说，上面四个框架，最开始的设计思路，与JPA、JDO( `Java Data Objects`)，可谓南辕北辙。很难说这类JPA框架，和以Mybatis为代表的ORM框架孰优孰劣，本文也不在此讨论此问题，下面着重分析下这四款'SQL'类的ORM框架的使用和优缺点。
<a name="J3PH6"></a>
# 对比
下面是Mybatis、Mybatis-Plus、Mybatis-Dynamic-SQL、jOOQ的四个简单使用使用。
<a name="lvDvY"></a>
## Mybatis
<a name="d19f2c10"></a>
#### 项目地址

- [https://github.com/mybatis/mybatis-3](https://github.com/mybatis/mybatis-3)
<a name="r6wpo"></a>
#### 基本使用

1. 基于注解的mapper
```java
package org.mybatis.example;
public interface BlogMapper {
  @Select("SELECT * FROM blog WHERE id = #{id}")
  Blog selectBlog(int id);
}
```

2. 基于xml的mapper
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.BlogMapper">
  <select id="selectBlog" resultType="Blog">
    select * from Blog where id = #{id}
  </select>
</mapper>
```
<a name="SLYeo"></a>
#### 动态SQL
> 官方文档地址: [https://mybatis.org/mybatis-3/dynamic-sql.html](https://mybatis.org/mybatis-3/dynamic-sql.html)
> 支持if、choose、trim、set、foreach，甚至可以支持在注解里使用_script_

1. if条件的动态SQL
```xml
<select id="findActiveBlogWithTitleLike"
     resultType="Blog">
  SELECT * FROM BLOG
  WHERE state = ‘ACTIVE’
  <if test="title != null">
    AND title like #{title}
  </if>
</select>
```

2. 在注解中使用_script_
```java
 @Update({"<script>",
      "update Author",
      "  <set>",
      "    <if test='username != null'>username=#{username},</if>",
      "    <if test='password != null'>password=#{password},</if>",
      "    <if test='email != null'>email=#{email},</if>",
      "    <if test='bio != null'>bio=#{bio}</if>",
      "  </set>",
      "where id=#{id}",
      "</script>"})
    void updateAuthorValues(Author author);
```
<a name="lbd2j"></a>
## Mybatis Dynamic SQL
<a name="3ZMxM"></a>
#### 项目地址:
[https://github.com/mybatis/mybatis-dynamic-sql](https://github.com/mybatis/mybatis-dynamic-sql)
<a name="2yysH"></a>
#### 基本使用：

<br />
<br />

<a name="UoSbj"></a>
## Mybatis Plus
<a name="uQdE7"></a>
#### 项目地址:
[https://github.com/baomidou/mybatis-plus](https://github.com/baomidou/mybatis-plus)
<a name="xSJJ7"></a>
#### 基本使用
引入相关依赖后，Mapper接口继承自 `BaseMapper` 接口即可。Mybatis-Plus也提供了自动生成TABLE的自动化工具(没找到plugin)，此处就暂时不引入了。
```java
    @Autowired
    private UserMapper userMapper;

    @Test
    public void testSelectByPrimaryKey() {
        User user = userMapper.selectById(3);
        Assertions.assertNotNull(user, "could not found user");
        log.info("user:{}", JSON.toJSONString(user));
    }

    @Test
    public void testQuery() {
        QueryWrapper<User> userQueryWrapper = new QueryWrapper<>();
        userQueryWrapper.select("id", "name", "age", "email").ge("age", 21);
        List<User> users = userMapper.selectList(userQueryWrapper);
        Assertions.assertTrue(users.size() == 3, "查询数量不符!");
        log.info("user:{}", JSON.toJSONString(users));
    }
```
<a name="Clyny"></a>
#### 框架分析
> 代码分析基于mybatis-plus 3.4.1版本

     Mybatis-plus自己定义了一个继承自Mybatis的 `org.apache.ibatis.session.SqlSessionFactoryBuilder` 自定义的 `SqlSessionFactoryBuild` : `com.baomidou.mybatisplus.core.MybatisSqlSessionFactoryBuilder` 用以构造自己的`SqlSessionFactory` 。<br />     在注册Mapper的地方，也使用了自定义的MapperRegistry `com.baomidou.mybatisplus.core.MybatisMapperRegistry` ,然后用自己的 `com.baomidou.mybatisplus.core.MybatisMapperAnnotationBuilder` 解析<br />`MybatisMapperAnnotationBuilder` 这个类就是注册mapper过程中的关键，它为没有xml的mapper接口注入了基础的CRUD方法。<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/240914/1608106920611-82617190-ea2e-433c-be26-6e538d6b7832.png#align=left&display=inline&height=501&margin=%5Bobject%20Object%5D&name=image.png&originHeight=668&originWidth=1169&size=201705&status=done&style=none&width=877)<br />对比Mybatis的 `org.apache.ibatis.builder.annotation.MapperAnnotationBuilder#parse` 方法，Mybatis-Plus在解析时主要就是红框部分的内容。在 `parseInjector()` 中循环注入了基础的CRUD方法。<br />下面的是默认会注入的方法:
```java
public class DefaultSqlInjector extends AbstractSqlInjector {

    @Override
    public List<AbstractMethod> getMethodList(Class<?> mapperClass) {
        return Stream.of(
            new Insert(),
            new Delete(),
            new DeleteByMap(),
            new DeleteById(),
            new DeleteBatchByIds(),
            new Update(),
            new UpdateById(),
            new SelectById(),
            new SelectBatchByIds(),
            new SelectByMap(),
            new SelectOne(),
            new SelectCount(),
            new SelectMaps(),
            new SelectMapsPage(),
            new SelectObjs(),
            new SelectList(),
            new SelectPage()
        ).collect(toList());
    }
}
```
<a name="FLOIn"></a>
## jOOQ


<a name="ehuCV"></a>
# 总结
<a name="s7BYV"></a>
## 几款框架的对比

<br />

<a name="GFXig"></a>
## JPA和ORM
